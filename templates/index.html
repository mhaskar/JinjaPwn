<!doctype html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>JinjaPwn - Generate and Test Malicious Jinja2 Expressions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .banner-gradient {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }
        pre {
            background: #020617;
            border: 1px solid #334155;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        .form-control, .form-select {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            color: #e2e8f0;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            background: rgba(15, 23, 42, 0.9);
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            color: #f1f5f9;
        }
        .form-control::placeholder {
            color: #64748b;
        }
        .copy-btn {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            color: #94a3b8;
            transition: all 0.3s ease;
        }
        .copy-btn:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: #475569;
            color: #e2e8f0;
        }
    </style>
</head>
<body class="text-slate-200">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
       <!-- 
      
        <div class="mb-8 banner-gradient text-amber-900 p-4 rounded-lg text-center font-bold shadow-lg">
            WARNING
        </div> -->

        <!-- Header Section -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent mb-4">
                JinjaPwn
            </h1>
            <p class="text-xl text-slate-400 font-medium">
                Generate and utilize Jinja2 expressions for Offensive operations
            </p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-8 space-y-3">
                    {% for category, msg in messages %}
                        <div class="alert p-4 rounded-lg border-l-4 {{ 'bg-red-900/50 border-red-500 text-red-200' if category == 'error' else 'bg-blue-900/50 border-blue-500 text-blue-200' }}" role="alert">
                            {{ msg }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Main Form -->
        <form method="post" action="{{ url_for('index') }}" id="builder-form" class="glass-card rounded-xl p-8 mb-8 shadow-2xl">
            <!-- Payload Selection -->
            <div class="mb-8">
                <label for="action_key" class="block text-lg font-semibold text-slate-200 mb-3">
                    Select Payload
                </label>
                <select class="form-select w-full md:w-2/3 p-3 rounded-lg text-lg" id="action_key" name="action_key" required>
                    <option value="" disabled {{ 'selected' if not selected_key }}>Choose an action…</option>
                    {% for item in items %}
                        <option value="{{ item.key }}" data-params='{{ item.params | tojson | safe }}' data-description="{{ item.description }}" {% if selected_key == item.key %}selected{% endif %}>
                            {{ item.label }}
                        </option>
                    {% endfor %}
                </select>
                <div class="mt-3 text-slate-400 text-sm font-medium" id="action-help"></div>
            </div>

            <hr class="border-slate-600 my-8">

            <!-- Dynamic Parameters -->
            <div id="params-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                {% if selected_key %}
                    {% for item in items %}
                        {% if item.key == selected_key %}
                            {% for spec in item.params %}
                                <div class="space-y-2">
                                    <label class="block text-sm font-semibold text-slate-200" for="param_{{ spec.name }}">
                                        {{ spec.label or spec.name }}
                                    </label>
                                    {% if spec.type == 'select' %}
                                        <select class="form-select w-full p-3 rounded-lg" id="param_{{ spec.name }}" name="{{ spec.name }}" {% if spec.required %}required{% endif %}>
                                            {% for choice in spec.choices %}
                                                <option value="{{ choice }}" {% if submitted_params.get(spec.name) == choice %}selected{% endif %}>
                                                    {{ choice }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <input class="form-control w-full p-3 rounded-lg mt-2" type="text" name="{{ spec.name }}_custom" id="param_{{ spec.name }}_custom" placeholder="Or enter a custom value" value="{{ submitted_params.get(spec.name + '_custom', '') }}" />
                                        <div class="text-xs text-slate-400 mt-1">
                                            Custom value overrides the selected option
                                        </div>
                                    {% else %}
                                        <input class="form-control w-full p-3 rounded-lg" id="param_{{ spec.name }}" name="{{ spec.name }}" type="text" value="{{ submitted_params.get(spec.name, '') }}" {% if spec.required %}required{% endif %} />
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>

            <!-- Submit Button -->
            <div class="flex justify-center">
                <button class="btn-primary px-8 py-4 rounded-lg text-white font-bold text-lg shadow-lg" type="submit">
                    Generate Expression
                </button>
            </div>
        </form>

        <!-- Generated Output -->
        {% if rendered %}
            <div class="glass-card rounded-xl overflow-hidden shadow-2xl mb-8">
                <div class="flex justify-between items-center p-6 border-b border-slate-600">
                    <h3 class="text-xl font-bold text-slate-200">Generated Expression</h3>
                    <div class="flex gap-3">
                        <!-- Added Test Expression button next to copy button -->
                        <button id="test-btn" class="copy-btn px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300" type="button">
                            Test Expression
                        </button>
                        <button id="copy-btn" class="copy-btn px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300" type="button">
                            Copy to clipboard
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <pre class="rounded-lg p-4 overflow-x-auto"><code class="text-green-400 font-mono">{{ rendered }}</code></pre>
                </div>
                <!-- Added test results section that shows when testing -->
                <div id="test-results" class="hidden border-t border-slate-600 p-6">
                    <h4 class="text-lg font-semibold text-slate-200 mb-3">Test Results</h4>
                    <div id="test-output" class="bg-slate-900 rounded-lg p-4 font-mono text-sm"></div>
                </div>
            </div>
        {% endif %}

    </div>

    <script>
        const items = {{ items | tojson | safe }};

        function createParamField(spec, submitted) {
            const container = document.createElement('div');
            container.className = 'space-y-2';

            const id = `param_${spec.name}`;
            const label = document.createElement('label');
            label.className = 'block text-sm font-semibold text-slate-200';
            label.setAttribute('for', id);
            label.textContent = spec.label || spec.name;

            let input;
            if (spec.type === 'select') {
                input = document.createElement('select');
                input.className = 'form-select w-full p-3 rounded-lg';
                input.name = spec.name;
                input.id = id;
                (spec.choices || []).forEach(choice => {
                    const opt = document.createElement('option');
                    opt.value = choice;
                    opt.textContent = choice;
                    if (submitted && submitted[spec.name] === choice) opt.selected = true;
                    input.appendChild(opt);
                });

                const custom = document.createElement('input');
                custom.className = 'form-control w-full p-3 rounded-lg mt-2';
                custom.type = 'text';
                custom.placeholder = 'Or enter a custom value';
                custom.name = `${spec.name}_custom`;
                custom.id = `${id}_custom`;
                if (submitted && submitted[`${spec.name}_custom`]) custom.value = submitted[`${spec.name}_custom`];

                const help = document.createElement('div');
                help.className = 'text-xs text-slate-400 mt-1';
                help.textContent = 'Custom value overrides the selected option';

                container.appendChild(label);
                container.appendChild(input);
                container.appendChild(custom);
                container.appendChild(help);
                return container;
            } else {
                input = document.createElement('input');
                input.className = 'form-control w-full p-3 rounded-lg';
                input.type = (spec.type === 'url' || spec.type === 'path' || spec.type === 'text') ? (spec.type === 'path' ? 'text' : spec.type) : 'text';
                input.name = spec.name;
                input.id = id;
                if (submitted && submitted[spec.name]) input.value = submitted[spec.name];
            }

            if (spec.required) input.required = true;

            container.appendChild(label);
            container.appendChild(input);
            return container;
        }

        function updateParams() {
            const select = document.getElementById('action_key');
            const help = document.getElementById('action-help');
            const container = document.getElementById('params-container');
            container.innerHTML = '';

            const key = select.value;
            const selected = items.find(i => i.key === key);
            help.textContent = selected ? selected.description : '';
            if (!selected) return;

            (selected.params || []).forEach(spec => {
                const field = createParamField(spec, {{ submitted_params | tojson | safe }});
                container.appendChild(field);
            });
        }

        document.getElementById('action_key').addEventListener('change', updateParams);
        window.addEventListener('DOMContentLoaded', updateParams);

        const copyBtn = document.getElementById('copy-btn');
        if (copyBtn) {
            copyBtn.addEventListener('click', async () => {
                const codeEl = document.querySelector('pre code');
                if (!codeEl) return;
                const text = codeEl.textContent;
                try {
                    await navigator.clipboard.writeText(text);
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => copyBtn.textContent = 'Copy to clipboard', 1200);
                } catch (e) {
                    copyBtn.textContent = 'Failed to copy';
                    setTimeout(() => copyBtn.textContent = 'Copy to clipboard', 1200);
                }
            });
        }

        const testBtn = document.getElementById('test-btn');
        if (testBtn) {
            testBtn.addEventListener('click', async () => {
                const codeEl = document.querySelector('pre code');
                if (!codeEl) return;
                
                const expression = codeEl.textContent;
                const testResults = document.getElementById('test-results');
                const testOutput = document.getElementById('test-output');
                
                testBtn.textContent = 'Testing...';
                testBtn.disabled = true;
                
                try {
                    const response = await fetch('/test-expression', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ expression: expression })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        testOutput.innerHTML = `
                            <div class="text-green-400 mb-2">Expression executed successfully</div>
                            <div class="text-slate-300">Output:</div>
                            <div class="text-blue-300 mt-1">${result.output || 'No output'}</div>
                        `;
                    } else {
                        testOutput.innerHTML = `
                            <div class="text-red-400 mb-2">Expression failed</div>
                            <div class="text-slate-300">Error:</div>
                            <div class="text-red-300 mt-1">${result.output || 'Unknown error'}</div>
                        `;
                    }
                    
                    testResults.classList.remove('hidden');
                } catch (error) {
                    testOutput.innerHTML = `
                        <div class="text-red-400 mb-2">✗ Network error</div>
                        <div class="text-red-300">${error.message}</div>
                    `;
                    testResults.classList.remove('hidden');
                } finally {
                    testBtn.textContent = 'Test Expression';
                    testBtn.disabled = false;
                }
            });
        }
    </script>
</body>
</html>
